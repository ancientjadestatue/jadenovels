<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if page.title %}{{ page.title }} - {{ site.title }}{% else %}{{ site.title }}{% endif %}</title>
    
    <!-- Optimized font loading and resource hints -->
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://api.fontshare.com">
    
    <!-- Critical CSS for LCP optimization -->
    <style>
        :root {
            --font-system: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            --size-author: clamp(120px, 20vw, 200px);
        }
        
        /* Critical hero styles */
        .hero { padding: 2rem 1rem; text-align: center; }
        .title--hero, .subtitle--hero { 
            font-family: var(--font-system); 
            font-display: swap; 
            margin: 1rem 0; 
        }
        .title--hero { 
            font-size: clamp(1.8rem, 8vw, 3.5rem); 
            font-weight: 600; 
            line-height: 1.2; 
            color: var(--title-dynamic, #1a1a1a); 
        }
        .subtitle--hero { 
            font-size: clamp(0.9rem, 4vw, 1.1rem); 
            max-width: 600px; 
            margin: 0 auto; 
            font-weight: 300; 
            line-height: 1.6; 
            color: var(--text-primary, #4a5568); 
        }
        .img-author { 
            width: var(--size-author); 
            height: var(--size-author); 
            border-radius: 50%; 
            object-fit: cover; 
            margin-bottom: 1.5rem; 
        }
        
        /* Font optimization */
        @font-face { 
            font-family: 'Inter-fallback'; 
            font-style: normal; 
            font-weight: 300 600; 
            font-display: swap; 
            src: local('Inter'), local('system-ui'), local('-apple-system'); 
        }
    </style>
    
    <!-- Preload critical hero image if on homepage -->
    {% if page.url == '/' or page.title contains 'Library' %}
    <link rel="preload" as="image" href="{{ '/assets/statue.jpeg' | relative_url }}" fetchpriority="high">
    {% endif %}
    
    <!-- Stylesheets with optimized font loading -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ '/assets/main.css' | relative_url }}">
    {% if page.layout == 'chapter' or page.title contains 'Chapter' %}
    <link rel="stylesheet" href="{{ '/assets/reader.css' | relative_url }}">
    {% endif %}
    <link rel="stylesheet" href="{{ '/assets/infinitybar.css' | relative_url }}">
    
    <!-- Unified Theme Detection & Styles -->
    <script>
        // Theme detection with consolidated logic
        (function() {
            const applyTheme = (isDark) => {
                document.documentElement[isDark ? 'removeAttribute' : 'setAttribute']('data-theme', 'light');
            };
            
            try {
                const stored = localStorage.getItem('theme') || 'auto';
                const isDark = stored === 'dark' || (stored === 'auto' && (
                    window.matchMedia('(prefers-color-scheme: dark)').matches || 
                    (() => { const h = new Date().getHours(); return h < 7 || h >= 19; })()
                ));
                applyTheme(isDark);
            } catch(e) {
                applyTheme(false); // Fallback to light
            }
        })();
    </script>
    
    <!-- Component Styles -->
    <link rel="stylesheet" href="{{ '/assets/components.css' | relative_url }}">
</head>
<body>
    <header>
        <div class="settings-nav">
            <div class="infinity-bar-section">
                <a href="{{ '/' | relative_url }}" class="logo" style="color: #f8f9fa;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                    </svg>
                </a>
            </div>
            <div style="flex:1; text-align:center;">
                <span class="logo" style="padding:0;">{{ site.title }}</span>
            </div>
            <button id="settings-btn" class="logo btn-base" style="color: #f8f9fa;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1Z"/>
                </svg>
            </button>
        </div>
    </header>

    <!-- Settings Panel -->
    <div id="settings-panel" class="settings-panel">
        <div class="settings-content">
            <div class="settings-header">
                <h3 class="settings-title">Settings</h3>
                <button id="close-settings" class="btn-base" style="color: var(--text-secondary); font-size: 1.5rem; padding: 0.5rem; border-radius: 50%;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>

            <div class="settings-section">
                <h4 class="settings-section-title">Appearance</h4>
                <div class="settings-card">
                    <div class="setting-item">
                        <span class="setting-label">Theme Mode</span>
                        <div id="theme-toggle" class="theme-toggle full">
                            <div class="theme-labels">
                                <span class="theme-label">üåô</span>
                                <span class="theme-label">üåì</span>
                                <span class="theme-label">‚òÄÔ∏è</span>
                            </div>
                            <div id="theme-slider" class="theme-slider full">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <p class="setting-description">Choose between dark, auto (system/time), or light mode</p>
                </div>
            </div>

            <div class="settings-section chapter-only">
                <h4 class="settings-section-title">Reading Preferences</h4>
                <div class="settings-card">
                    <div class="control-group">
                        <div class="control-label">
                            <span class="setting-label">Font Size</span>
                            <span class="control-value" id="font-size-value">100%</span>
                        </div>
                        <input type="range" id="font-size-slider" class="range-slider" 
                               min="80" max="150" value="100" step="5">
                        <p class="setting-description">Adjust text size for comfortable reading</p>
                    </div>
                    
                    <div class="control-group">
                        <div class="control-label">
                            <span class="setting-label">Line Height</span>
                            <span class="control-value" id="line-height-value">1.7</span>
                        </div>
                        <input type="range" id="line-height-slider" class="range-slider" 
                               min="1.4" max="2.2" value="1.7" step="0.1">
                        <p class="setting-description">Control spacing between lines</p>
                    </div>
                    
                    <div class="control-group">
                        <div class="control-label">
                            <span class="setting-label">Reading Width (for wide screens)</span>
                        </div>
                        <select id="reading-width-select" class="select-dropdown">
                            <option value="55ch">Narrow (55ch)</option>
                            <option value="65ch" selected>Comfortable (65ch)</option>
                            <option value="75ch">Wide (75ch)</option>
                            <option value="85ch">Extra Wide (85ch)</option>
                            <option value="100%">Full Width</option>
                        </select>
                        <p class="setting-description">Choose optimal line length for reading</p>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h4 class="settings-section-title">Advanced Options</h4>
                <div class="settings-card disabled">
                    <p class="coming-soon-text">More customization options coming soon...</p>
                </div>
            </div>

            <div class="settings-footer">
                <p class="settings-footer-text">Settings are saved automatically</p>
            </div>
        </div>
    </div>

    <div id="settings-overlay" class="settings-overlay"></div>

    <!-- Reading Progress Bar -->
    {% if page.title contains 'Chapter' or page.chapter %}
    <div class="reading-progress progress-bar">
        <div class="progress-fill" id="reading-progress"></div>
    </div>
    {% endif %}

    <main>
        {% if page.title contains 'Chapter' or page.chapter %}
        <div class="chapter-container">
            <div class="chapter-content">
                {{ content }}
            </div>
        </div>
        {% else %}
        {{ content }}
        {% endif %}
    </main>

    <footer>
        <div>
            <p>Last updated: <span id="current-date"></span></p>
            <p>Made with 
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="display: inline; vertical-align: middle; color: #e74c3c;">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                </svg>
                for romance lovers everywhere
            </p>
        </div>
    </footer>

    <!-- Infinity Bar -->
    <div class="infinity-bar" id="infinity-bar">
        <div class="infinity-bar-content">
            <!-- Primary Layer (Always Visible) -->
            <div class="infinity-bar-primary">
                {% if page.title contains 'Chapter' or page.chapter %}
                <div class="infinity-bar-section">
                    <button class="infinity-bar-expand-btn" id="infinity-expand-btn" aria-label="Expand options">
                        <svg class="expand-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 19l-7-7h14l-7 7z"/>
                        </svg>
                    </button>
                </div>
                
                <div class="chapter-nav">
                    {% assign current_chapter = page.chapter | plus: 0 %}
                    {% assign prev_chapter = current_chapter | minus: 1 %}
                    {% assign next_chapter = current_chapter | plus: 1 %}
                    
                    {% if prev_chapter > 0 %}
                        <a href="{{ '/books/' | append: page.book | downcase | append: '/chapter' | append: prev_chapter | relative_url }}" class="chapter-nav-btn">
                            ‚Üê Prev
                        </a>
                    {% else %}
                        <span class="chapter-nav-btn chapter-nav-btn--disabled">
                            ‚Üê Prev
                        </span>
                    {% endif %}
                    
                    <div class="chapter-dropdown" id="chapter-dropdown">
                        <div class="chapter-dropdown-backdrop"></div>
                        <button class="chapter-dropdown-btn" id="chapter-dropdown-btn" 
                                aria-expanded="false" aria-haspopup="true">
                            Ch {{ current_chapter }}
                            <span class="chapter-dropdown-arrow">‚ñº</span>
                        </button>
                        <div class="chapter-dropdown-menu" id="chapter-dropdown-menu" role="menu">
                            <a href="{{ '/books/' | append: page.book | downcase | relative_url }}" class="chapter-dropdown-item" role="menuitem">All Chapters</a>
                            {% for i in (1..6) %}
                                <a href="{{ '/books/' | append: page.book | downcase | append: '/chapter' | append: i | relative_url }}" 
                                   class="chapter-dropdown-item{% if i == current_chapter %} current{% endif %}"
                                   role="menuitem">
                                    Chapter {{ i }}: {% if i == 1 %}The Morning Routine{% elsif i == 2 %}You're a lifesaver! Minseo!{% elsif i == 3 %}After Hours{% elsif i == 4 %}Small Luxuries{% elsif i == 5 %}Team Leader...Minseo?{% elsif i == 6 %}Evening Light{% endif %}
                                </a>
                            {% endfor %}
                        </div>
                    </div>
                    
                    {% if next_chapter <= 6 %}
                        <a href="{{ '/books/' | append: page.book | downcase | append: '/chapter' | append: next_chapter | relative_url }}" class="chapter-nav-btn">
                            Next ‚Üí
                        </a>
                    {% else %}
                        <span class="chapter-nav-btn chapter-nav-btn--disabled">
                            Next ‚Üí
                        </span>
                    {% endif %}
                </div>
                {% else %}
                <!-- Continue Reading Pill on non-chapter pages -->
                <div class="infinity-bar-section infinity-bar-nav">
                    <button class="continue-reading-pill" id="continue-reading-pill-nav">
                        <svg class="continue-reading-pill-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
                        </svg>
                        <span class="continue-reading-pill-text" id="continue-reading-pill-text-nav">Continue Reading: Unfiltered</span>
                        <div class="continue-reading-pill-progress" id="continue-reading-pill-progress-nav"></div>
                    </button>
                </div>
                {% endif %}
                
                <div class="infinity-bar-section infinity-bar-actions">
                    <a href="{{ '/books' | relative_url }}" class="infinity-bar-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                        </svg>
                        <span>Library</span>
                    </a>
                    <div id="mini-theme-toggle" class="theme-toggle mini">
                        <div id="mini-theme-slider" class="theme-slider mini">
                            <svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Secondary Layer (Expandable) -->
            {% if page.title contains 'Chapter' or page.chapter %}
            <div class="infinity-bar-secondary">
                <div class="infinity-bar-secondary-section">
                    <h4>Actions</h4>
                    <div class="infinity-quick-actions">
                        <button class="infinity-bar-secondary-btn" id="infinity-bookmark-btn">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
                            </svg>
                            <span>Bookmark</span>
                        </button>
                        <button class="infinity-bar-secondary-btn" id="infinity-share-btn">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="18" cy="5" r="3"/>
                                <circle cx="6" cy="12" r="3"/>
                                <circle cx="18" cy="19" r="3"/>
                                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                                <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                            </svg>
                            <span>Share</span>
                        </button>
                    </div>
                </div>
                
                <div class="infinity-bar-divider"></div>
                
                <div class="infinity-bar-secondary-section">
                    <h4>Reading</h4>
                    <div class="infinity-quick-actions">
                        <button class="infinity-bar-secondary-btn" id="infinity-text-size-btn">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 7V4h16v3M9 20h6M12 4v16"/>
                            </svg>
                            <span>Text Size</span>
                        </button>
                        <button class="infinity-bar-secondary-btn" id="infinity-focus-btn">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                            <span>Focus</span>
                        </button>
                        <button class="infinity-bar-secondary-btn" id="infinity-notes-btn">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14,2 14,8 20,8"/>
                                <line x1="16" y1="13" x2="8" y2="13"/>
                                <line x1="16" y1="17" x2="8" y2="17"/>
                                <polyline points="10,9 9,9 8,9"/>
                            </svg>
                            <span>Notes</span>
                        </button>
                    </div>
                </div>
                
                <div class="infinity-bar-divider"></div>
                
                <div class="infinity-bar-secondary-section">
                    <h4>Quick</h4>
                    <div class="infinity-quick-actions">
                        <button class="infinity-bar-secondary-btn" id="infinity-auto-scroll-btn">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 5v14m-7-7l7-7 7 7"/>
                            </svg>
                            <span>Auto Scroll</span>
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <script>
        // Make site configuration available to JavaScript
        window.SITE_CONFIG = {
            baseurl: '{{ site.baseurl }}',
            url: '{{ site.url }}'
        };
    </script>
    <script src="{{ '/assets/app-core.js' | relative_url }}"></script>
    <script src="{{ '/assets/infinitybarbuttons.js' | relative_url }}"></script>
</body>
</html>